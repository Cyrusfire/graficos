<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Distribución de Fondos</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0; 
            background: transparent !important; 
            display: flex; 
            align-items: center;
            justify-content: center;
            width: 100vw;
            height: 100vh;
            box-sizing: border-box;
            font-family: Arial, sans-serif;
            color: #ffffff; 
        }
        #chartContainer {
            display: flex; 
            width: 100%;   
            height: 100%;  
            max-width: 100%; 
        }
        #canvasWrapper {
            flex-grow: 1;
            flex-basis: 60%; 
            position: relative;
            min-width: 0; 
            height: 100%;
            display: flex; 
            align-items: center;
            justify-content: center;
        }
        canvas {
            display: block;
            max-width: 100%; 
            max-height: 100%;
        }
        #legendWrapper {
            flex-basis: 40%; 
            padding-left: 20px; 
            overflow-y: auto; 
            height: 100%;
            color: #ffffff;
            font-size: 13px; 
            box-sizing: border-box; 
        }
        #legendWrapper h3 { 
            margin-top: 5px; 
            margin-bottom: 15px;
            font-size: 16px;
            padding-bottom: 10px;
            color: #ffffff; 
        }
        #legendList {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        #legendList li {
            display: flex;
            align-items: center;
            margin-bottom: 10px; 
            padding: 4px;
            border-radius: 3px;
            transition: background-color 0.2s;
            cursor: default; 
        }
        .legend-color-box {
            display: inline-block;
            width: 14px;
            height: 14px;
            margin-right: 10px;
            border-radius: 3px;
            border: 1px solid rgba(255,255,255,0.5); 
        }
        .legend-text {
            flex-grow: 1; 
            color: #ffffff; 
        }
        .legend-amount {
            font-weight: bold;
            margin-left: 8px; 
            color: #ffffff; 
        }
        .legend-percentage {
            color: #e0e0e0; 
            margin-left: 5px;
        }
        #loader {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 16px; 
            color: #ffffff;
            background-color: rgba(0,0,0,0.6); 
            padding: 12px 20px;
            border-radius: 5px;
            z-index:10;
            text-align: center;
        }
    </style>
</head>
<body>
    <div id="chartContainer">
        <div id="canvasWrapper">
            <canvas id="graficoTortaGithub"></canvas>
            <div id="loader">Cargando datos...</div>
        </div>
        <div id="legendWrapper">
            <ul id="legendList"></ul>
        </div>
    </div>

    <script>
        const ctx = document.getElementById('graficoTortaGithub').getContext('2d');
        const loaderElement = document.getElementById('loader');
        const legendListElement = document.getElementById('legendList');
        let graficoInstance;

        function formatCurrency(value, currency = 'USD') {
            if (typeof value !== 'number' || isNaN(value)) {
                console.warn(`formatCurrency recibió un valor no numérico: ${value}. Se mostrará como 0.`);
                value = 0;
            }
            // ----- ¡IMPORTANTE! AJUSTA LA LÍNEA SIGUIENTE A TU MONEDA Y FORMATO REGIONAL -----
            // Ejemplo para Dólares Americanos (EE.UU.):
            // return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(value);
            
            // Ejemplo para Bolívares (Venezuela) - VED es el código actual:
            return new Intl.NumberFormat('es-VE', { style: 'currency', currency: 'VED', minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(value);
            
            // Ejemplo para Euros (España):
            // return new Intl.NumberFormat('es-ES', { style: 'currency', currency: 'EUR', minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(value);
        }
        
        function generateCustomLegend(chart) {
            legendListElement.innerHTML = ''; 
            const data = chart.data;
            if (!data.datasets || !data.datasets.length || !data.datasets[0].data) {
                console.error("generateCustomLegend: Faltan datasets o datos en el dataset.");
                legendListElement.innerHTML = '<li>Error al generar leyenda: datos incompletos.</li>';
                return;
            }

            const numericData = data.datasets[0].data.map(val => {
                const num = parseFloat(val);
                return isNaN(num) ? 0 : num;
            });

            const totalGeneral = numericData.reduce((sum, val) => sum + val, 0);

            if (data.labels && data.labels.length && data.datasets.length) {
                data.labels.forEach((label, i) => {
                    const dataset = data.datasets[0];
                    const valor = numericData[i]; 
                    const backgroundColor = dataset.backgroundColor[i % dataset.backgroundColor.length]; 
                    const borderColor = dataset.borderColor; 
                    const porcentaje = totalGeneral > 0 ? ((valor / totalGeneral) * 100).toFixed(2) : "0.00";

                    const listItem = document.createElement('li');
                    const colorBox = document.createElement('span');
                    colorBox.className = 'legend-color-box';
                    colorBox.style.backgroundColor = backgroundColor;

                    const textSpan = document.createElement('span');
                    textSpan.className = 'legend-text';
                    textSpan.textContent = (label || "Sin etiqueta") + ": "; 

                    const amountSpan = document.createElement('span');
                    amountSpan.className = 'legend-amount';
                    amountSpan.textContent = formatCurrency(valor); 

                    const percentageSpan = document.createElement('span');
                    percentageSpan.className = 'legend-percentage';
                    percentageSpan.textContent = `(${porcentaje}%)`;
                    
                    listItem.appendChild(colorBox);
                    listItem.appendChild(textSpan);
                    listItem.appendChild(amountSpan);
                    listItem.appendChild(percentageSpan);
                    legendListElement.appendChild(listItem);
                });
            } else {
                console.warn("generateCustomLegend: Faltan labels o datasets para generar leyenda.");
                legendListElement.innerHTML = '<li>No hay etiquetas para la leyenda.</li>';
            }
        }

        window.addEventListener('message', (event) => {
            console.log("Mensaje recibido en iframe:", event.data); 

            // --- Verificación de Origen (DESCOMENTAR Y AJUSTAR EN PRODUCCIÓN) ---
            // const allowedOrigins = ['https://TU-DOMINIO-WIX.wixsite.com', 'https://editor.wix.com'];
            // if (!allowedOrigins.includes(event.origin) && event.origin !== 'https://cyrusfire.github.io') { 
            //     console.error("Mensaje ignorado de origen no permitido:", event.origin);
            //     loaderElement.textContent = "Error: Origen no válido.";
            //     legendListElement.innerHTML = '<li>Error: Origen de datos no permitido.</li>';
            //     return;
            // }

            if (!event.data || typeof event.data !== 'object') {
                console.error("Error: event.data no es un objeto o es nulo.", event.data);
                loaderElement.textContent = "Error: Datos recibidos no válidos.";
                legendListElement.innerHTML = '<li>Error: Formato de datos incorrecto.</li>';
                if (graficoInstance) graficoInstance.destroy();
                loaderElement.style.display = 'block';
                return;
            }

            const { labels, valores, titulo } = event.data;

            if (!Array.isArray(labels) || !Array.isArray(valores)) {
                console.error("Error: 'labels' o 'valores' no son arrays.", "Labels:", labels, "Valores:", valores);
                loaderElement.textContent = "Error: Estructura de datos incorrecta.";
                legendListElement.innerHTML = "<li>Error: 'labels' o 'valores' no son listas.</li>";
                if (graficoInstance) graficoInstance.destroy();
                loaderElement.style.display = 'block';
                return;
            }
            
            const numericValores = valores.map(v => {
                const num = parseFloat(v);
                if (isNaN(num)) {
                    console.warn(`Valor no numérico encontrado en 'valores': '${v}'. Se reemplazará por 0.`);
                    return 0;
                }
                return num;
            });

            if (labels.length === 0 || numericValores.length === 0 || labels.length !== numericValores.length) {
                console.warn("Advertencia: 'labels' o 'valores' están vacíos, o no coinciden en longitud.", "Labels:", labels.length, "Valores:", numericValores.length);
                loaderElement.textContent = "No hay datos suficientes o los datos son inconsistentes.";
                legendListElement.innerHTML = '<li>No hay datos para mostrar o son inconsistentes.</li>';
                if (graficoInstance) graficoInstance.destroy();
                loaderElement.style.display = 'block';
                return;
            }
            
            loaderElement.style.display = 'none'; 

            if (graficoInstance) {
                graficoInstance.destroy();
            }

            try {
                graficoInstance = new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: labels, 
                        datasets: [{
                            data: numericValores, 
                            backgroundColor: [
                                '#36A2EB', '#FFCE56', '#FF6384', '#4BC0C0', '#9966FF', '#FF9F40',
                                '#8AC926', '#1982C4', '#F45B69', '#6A4C93', '#2ECC71', '#E74C3C',
                                '#F39C12', '#D35400', '#C0392B' 
                            ],
                            borderColor: 'rgba(0,0,0,0.1)', 
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: titulo || 'Distribución de Fondos',
                                color: '#FFFFFF', 
                                font: { size: 16, weight: 'bold' },
                                padding: { top: 10, bottom: 15 }
                            },
                            legend: { display: false }, // Usamos la leyenda HTML personalizada
                            tooltip: { 
                                enabled: true,
                                backgroundColor: 'rgba(0,0,0,0.85)',
                                titleColor: '#FFFFFF', bodyColor: '#FFFFFF',
                                titleFont: { size: 13, weight: 'bold' }, bodyFont: { size: 12 },
                                padding: 8,
                                callbacks: {
                                    label: function(context) {
                                        let tooltipLabel = '';
                                        const dataLabel = context.chart.data.labels[context.dataIndex];
                                        const value = context.parsed; 
                                        const total = context.dataset.data.reduce((a, b) => (parseFloat(a) || 0) + (parseFloat(b) || 0), 0);

                                        if (dataLabel) tooltipLabel = dataLabel + ': ';
                                        if (typeof value === 'number' && !isNaN(value)) {
                                            tooltipLabel += formatCurrency(value);
                                            const percentage = total > 0 ? ((value / total) * 100).toFixed(2) + '%' : '0.00%';
                                            tooltipLabel += ' (' + percentage + ')';
                                        } else {
                                            tooltipLabel += "Dato no disponible";
                                        }
                                        return tooltipLabel;
                                    }
                                }
                            }
                        }
                    },
                    plugins: [{ // Plugin para generar la leyenda personalizada
                        id: 'customLegendPlugin',
                        afterUpdate: function(chart) { 
                            generateCustomLegend(chart);
                        }
                    }]
                });
            } catch (chartError) {
                console.error("Error al crear la instancia de Chart.js:", chartError);
                loaderElement.textContent = "Error crítico al generar gráfico.";
                legendListElement.innerHTML = `<li>Error: ${chartError.message}</li>`;
                loaderElement.style.display = 'block';
            }
        });
    </script>
</body>
</html>
