<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Distribución de Fondos</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: transparent !important;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100vw;
            height: 100vh;
            box-sizing: border-box;
            font-family: Arial, sans-serif;
            color: #ffffff;
        }
        #chartContainer {
            display: flex;
            width: 100%;
            height: 100%;
            max-width: 100%;
        }
        #canvasWrapper {
            flex-grow: 1;
            flex-basis: 60%;
            position: relative;
            min-width: 0;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        canvas {
            display: block;
            max-width: 100%;
            max-height: 100%;
        }
        #legendWrapper {
            flex-basis: 40%;
            padding-left: 20px;
            overflow-y: auto;
            height: 100%;
            color: #ffffff;
            font-size: 13px;
            box-sizing: border-box;
        }
        #legendWrapper h3 {
            margin-top: 5px;
            margin-bottom: 15px;
            font-size: 16px;
            padding-bottom: 10px;
            color: #ffffff;
        }
        #legendList {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        #legendList li {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            padding: 4px;
            border-radius: 3px;
            transition: background-color 0.2s;
            cursor: default;
        }
        .legend-color-box {
            display: inline-block;
            width: 14px;
            height: 14px;
            margin-right: 10px;
            border-radius: 3px;
            border: 1px solid rgba(255,255,255,0.5);
        }
        .legend-text {
            flex-grow: 1;
            color: #ffffff;
        }
        .legend-amount {
            font-weight: bold;
            margin-left: 8px;
            color: #ffffff;
        }
        .legend-percentage {
            color: #e0e0e0;
            margin-left: 5px;
        }
        #loader {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 16px;
            color: #ffffff;
            background-color: rgba(0,0,0,0.6);
            padding: 12px 20px;
            border-radius: 5px;
            z-index:10;
            text-align: center;
        }
    </style>
</head>
<body>
    <div id="chartContainer">
        <div id="canvasWrapper">
            <canvas id="graficoTortaGithub"></canvas>
            <div id="loader">Cargando datos...</div>
        </div>
        <div id="legendWrapper">
            <ul id="legendList"></ul>
        </div>
    </div>

    <script>
        const ctx = document.getElementById('graficoTortaGithub').getContext('2d');
        const loaderElement = document.getElementById('loader');
        const legendListElement = document.getElementById('legendList');
        let graficoInstance = null;

        // Función para formatear moneda
        function formatCurrency(value, currencyCode = 'VED', locale = 'es-VE') {
            if (typeof value !== 'number' || isNaN(value)) {
                console.warn(`formatCurrency recibió un valor no numérico: ${value}. Se mostrará como 0.`);
                value = 0;
            }
            try {
                return new Intl.NumberFormat(locale, { style: 'currency', currency: currencyCode, minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(value);
            } catch (e) {
                console.error("Error al formatear moneda. Usando formato simple:", e);
                return `${currencyCode} ${value.toFixed(2)}`;
            }
        }

        // Función para generar la leyenda personalizada
        function generateCustomLegend(chart) {
            legendListElement.innerHTML = '';
            const data = chart.data;
            if (!data || !data.datasets || !data.datasets.length || !data.datasets[0].data || !data.datasets[0].data.length) {
                console.error("generateCustomLegend: Datos insuficientes para la leyenda.", data);
                legendListElement.innerHTML = '<li>Error: Datos de leyenda incompletos.</li>';
                return;
            }
            const numericData = data.datasets[0].data.map(val => parseFloat(val) || 0);
            const totalGeneral = numericData.reduce((sum, val) => sum + val, 0);

            if (data.labels && data.labels.length) {
                data.labels.forEach((label, i) => {
                    const dataset = data.datasets[0];
                    const valor = numericData[i];
                    const backgroundColor = dataset.backgroundColor[i % dataset.backgroundColor.length];
                    const porcentaje = totalGeneral > 0 ? ((valor / totalGeneral) * 100).toFixed(2) : "0.00";

                    const listItem = document.createElement('li');
                    const colorBox = document.createElement('span');
                    colorBox.className = 'legend-color-box';
                    colorBox.style.backgroundColor = backgroundColor;

                    const textSpan = document.createElement('span');
                    textSpan.className = 'legend-text';
                    textSpan.textContent = (label || "Sin etiqueta") + ": ";

                    const amountSpan = document.createElement('span');
                    amountSpan.className = 'legend-amount';
                    amountSpan.textContent = formatCurrency(valor);

                    const percentageSpan = document.createElement('span');
                    percentageSpan.className = 'legend-percentage';
                    percentageSpan.textContent = `(${porcentaje}%)`;

                    listItem.appendChild(colorBox);
                    listItem.appendChild(textSpan);
                    listItem.appendChild(amountSpan);
                    listItem.appendChild(percentageSpan);
                    legendListElement.appendChild(listItem);
                });
            } else {
                legendListElement.innerHTML = '<li>No hay etiquetas para la leyenda.</li>';
            }
        }

        // Event listener para mensajes de Wix
        window.addEventListener('message', (event) => {
            console.log("IFRAME: Mensaje recibido. Origen:", event.origin);
            console.log("IFRAME: Tipo de event.data (RAW):", typeof event.data);
            console.log("IFRAME: Contenido de event.data (RAW):", event.data);

            // --- Medida de seguridad: Verificar el origen (DESCOMENTAR Y AJUSTAR EN PRODUCCIÓN) ---
            // const trustedOrigins = ['https://TU-SITIO-WIX.wixsite.com', 'https://editor.wix.com', 'https://TU-USUARIO.github.io'];
            // if (!trustedOrigins.some(origin => event.origin.startsWith(origin))) {
            //     console.warn("IFRAME: Mensaje de origen no confiable ignorado:", event.origin);
            //     return;
            // }

            let dataPayload = event.data;

            if (typeof dataPayload === 'string') {
                console.log("IFRAME: event.data es un string. Intentando JSON.parse().");
                try {
                    dataPayload = JSON.parse(dataPayload);
                    console.log("IFRAME: JSON.parse() exitoso. Payload:", dataPayload);
                } catch (e) {
                    console.error("IFRAME ERROR: Falló JSON.parse(). Error:", e, "String original:", event.data);
                    loaderElement.textContent = "Error: Datos recibidos corruptos.";
                    legendListElement.innerHTML = '<li>Error: Datos ilegibles.</li>';
                    if (graficoInstance) { graficoInstance.destroy(); graficoInstance = null; }
                    loaderElement.style.display = 'block';
                    document.getElementById('graficoTortaGithub').style.display = 'none';
                    return;
                }
            }

            if (typeof dataPayload !== 'object' || dataPayload === null) {
                console.error("IFRAME ERROR: El payload procesado no es un objeto válido.", dataPayload);
                loaderElement.textContent = "Error: Formato de datos no válido.";
                legendListElement.innerHTML = '<li>Error: Datos no son un objeto.</li>';
                if (graficoInstance) { graficoInstance.destroy(); graficoInstance = null; }
                loaderElement.style.display = 'block';
                document.getElementById('graficoTortaGithub').style.display = 'none';
                return;
            }

            const { labels, valores, titulo, error: dataError, message: errorMessage } = dataPayload;

            console.log("IFRAME: Datos destructurados -> labels:", labels, "(es array:", Array.isArray(labels), ")");
            console.log("IFRAME: Datos destructurados -> valores:", valores, "(es array:", Array.isArray(valores), ")");
            console.log("IFRAME: Datos destructurados -> titulo:", titulo);

            if (dataError) {
                console.error("IFRAME: Error reportado desde Velo:", errorMessage);
                loaderElement.textContent = `Error de Velo: ${errorMessage || "Desconocido"}`;
                legendListElement.innerHTML = `<li>Error Velo: ${errorMessage || "Ver consola"}</li>`;
                if (graficoInstance) { graficoInstance.destroy(); graficoInstance = null; }
                loaderElement.style.display = 'block';
                document.getElementById('graficoTortaGithub').style.display = 'none';
                return;
            }

            if (!Array.isArray(labels) || !Array.isArray(valores)) {
                console.error("IFRAME ERROR CRÍTICO: 'labels' o 'valores' NO SON ARRAYS.", "Tipo labels:", typeof labels, "Tipo valores:", typeof valores);
                loaderElement.textContent = "Error: Estructura de datos incorrecta (no son arrays).";
                legendListElement.innerHTML = "<li>Error: 'labels' o 'valores' deben ser listas.</li>";
                if (graficoInstance) { graficoInstance.destroy(); graficoInstance = null; }
                loaderElement.style.display = 'block';
                document.getElementById('graficoTortaGithub').style.display = 'none';
                return;
            }

            const numericValores = valores.map(v => parseFloat(v) || 0);

            if (labels.length === 0 && numericValores.every(v => v === 0)) {
                 console.warn("IFRAME: 'labels' vacío y 'valores' son todos cero o vacíos. Mostrando mensaje de 'Sin datos'.");
                 loaderElement.textContent = titulo || "No hay datos para mostrar.";
                 legendListElement.innerHTML = '<li>No hay datos disponibles.</li>';
                 if (graficoInstance) { graficoInstance.destroy(); graficoInstance = null; }
                 loaderElement.style.display = 'block';
                 document.getElementById('graficoTortaGithub').style.display = 'none';
                 return;
            }

            if (labels.length !== numericValores.length) {
                console.warn("IFRAME Advertencia: 'labels' y 'valores' no coinciden en longitud.", "Labels:", labels.length, "Valores:", numericValores.length);
                loaderElement.textContent = "Datos inconsistentes (longitudes no coinciden).";
                legendListElement.innerHTML = '<li>Error: Inconsistencia en datos.</li>';
                if (graficoInstance) { graficoInstance.destroy(); graficoInstance = null; }
                loaderElement.style.display = 'block';
                document.getElementById('graficoTortaGithub').style.display = 'none';
                return;
            }

            loaderElement.style.display = 'none';
            document.getElementById('graficoTortaGithub').style.display = 'block';

            if (graficoInstance) {
                graficoInstance.destroy();
                graficoInstance = null;
            }

            try {
                graficoInstance = new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: numericValores,
                            backgroundColor: [
                                '#36A2EB', '#FFCE56', '#FF6384', '#4BC0C0', '#9966FF', '#FF9F40',
                                '#8AC926', '#1982C4', '#F45B69', '#6A4C93', '#2ECC71', '#E74C3C',
                                '#F39C12', '#D35400', '#C0392B'
                            ],
                            borderColor: 'rgba(0,0,0,0.1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: titulo || 'Distribución de Fondos',
                                color: '#FFFFFF',
                                font: { size: 16, weight: 'bold' },
                                padding: { top: 10, bottom: 15 }
                            },
                            legend: { display: false },
                            tooltip: {
                                enabled: true,
                                backgroundColor: 'rgba(0,0,0,0.85)',
                                titleColor: '#FFFFFF', bodyColor: '#FFFFFF',
                                titleFont: { size: 13, weight: 'bold' }, bodyFont: { size: 12 },
                                padding: 8,
                                callbacks: {
                                    label: function(context) {
                                        let tooltipLabel = '';
                                        const dataLabel = context.chart.data.labels[context.dataIndex];
                                        const value = context.parsed;
                                        let total = 0;
                                        if (context.dataset && context.dataset.data && context.dataset.data.length > 0) {
                                            total = context.dataset.data.reduce((a, b) => (parseFloat(a) || 0) + (parseFloat(b) || 0), 0);
                                        }
                                        if (dataLabel) tooltipLabel = dataLabel + ': ';
                                        if (typeof value === 'number' && !isNaN(value)) {
                                            tooltipLabel += formatCurrency(value);
                                            const percentage = total > 0 ? ((value / total) * 100).toFixed(2) + '%' : '0.00%';
                                            tooltipLabel += ' (' + percentage + ')';
                                        } else {
                                            tooltipLabel += "Dato no disponible";
                                        }
                                        return tooltipLabel;
                                    }
                                }
                            }
                        }
                    },
                    plugins: [{
                        id: 'customLegendPlugin',
                        afterUpdate: function(chart) {
                            generateCustomLegend(chart);
                        }
                    }]
                });
            } catch (chartError) {
                console.error("IFRAME Error al crear Chart.js:", chartError);
                loaderElement.textContent = "Error crítico al generar gráfico.";
                legendListElement.innerHTML = `<li>Error gráfico: ${chartError.message}</li>`;
                if (graficoInstance) { graficoInstance.destroy(); graficoInstance = null; }
                loaderElement.style.display = 'block';
                document.getElementById('graficoTortaGithub').style.display = 'none';
            }
        });

        // Mensaje inicial si no se reciben datos
        setTimeout(() => {
            if (!graficoInstance && loaderElement.style.display !== 'none' && loaderElement.textContent === "Cargando datos...") {
                console.log("IFRAME: Timeout, no se recibieron datos iniciales de Velo.");
                loaderElement.textContent = "Esperando datos de Wix...";
            }
        }, 7000); // Aumentado el timeout a 7 segundos
    </script>
</body>
</html>
