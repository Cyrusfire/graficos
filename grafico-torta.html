<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Distribución de Fondos</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: transparent !important; /* Fondo transparente */
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100vw;
            height: 100vh;
            font-family: Arial, sans-serif; /* Fuente base */
            color: #ffffff; /* Color de texto por defecto para el loader */
        }
        #chartContainer {
            display: flex; /* Usar flex para distribuir espacio entre gráfico y leyenda */
            width: 98%;
            height: 98%;
            max-width: 700px; /* Aumentamos un poco para dar espacio a la leyenda vertical */
        }
        #canvasWrapper { /* Contenedor para el canvas del gráfico */
            flex-grow: 1; /* El gráfico tomará el espacio disponible */
            position: relative; /* Para el loader */
            min-width: 0; /* Necesario para flexbox en algunos navegadores */
        }
        canvas {
            display: block;
            width: 100%;
            height: 100%;
        }
        #loader {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 16px;
            color: #ffffff; /* Aseguramos color blanco para el loader */
        }
        /* Estilos adicionales para la leyenda si es necesario (Chart.js la maneja bastante bien) */
        .chartjs-legend {
            padding-left: 20px; /* Espacio si la leyenda está a la derecha */
            max-width: 200px; /* Ancho máximo para la leyenda vertical */
            overflow-y: auto; /* Scroll si hay muchos ítems */
            color: #ffffff !important; /* Forzar color blanco */
        }
        .chartjs-legend ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .chartjs-legend li {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            color: #ffffff !important; /* Forzar color blanco */
            font-size: 12px;
        }
        .chartjs-legend span {
            display: inline-block;
            width: 12px;
            height: 12px;
            margin-right: 8px;
            border-radius: 2px;
        }
    </style>
</head>
<body>
    <div id="chartContainer">
        <div id="canvasWrapper">
            <canvas id="graficoTorta"></canvas>
            <div id="loader">Cargando gráfico...</div>
        </div>
        </div>

    <script>
        const ctx = document.getElementById('graficoTorta').getContext('2d');
        const loaderElement = document.getElementById('loader');
        let grafico;

        // Función para formatear moneda (ajusta 'es-VE' y 'VES' o 'USD' según necesites)
        function formatCurrency(value, currency = 'USD') {
            return new Intl.NumberFormat('es-VE', { style: 'currency', currency: currency, minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(value);
        }

        window.addEventListener('message', (event) => {
            // --- Verificación de Origen (Opcional) ---
            // const allowedOrigins = ['https://TU-DOMINIO-WIX.wixsite.com', 'https://editor.wix.com', 'https://cyrusfire.github.io'];
            // if (!allowedOrigins.includes(event.origin)) {
            //   console.warn("Mensaje ignorado de origen no permitido:", event.origin);
            //   loaderElement.innerText = "Error: Origen no permitido.";
            //   return;
            // }

            if (event.data &&
                typeof event.data === 'object' &&
                Array.isArray(event.data.labels) &&
                Array.isArray(event.data.valores)) {

                const { labels, valores, titulo } = event.data;
                const totalGeneral = valores.reduce((sum, val) => sum + parseFloat(val), 0);

                if (labels.length === 0 || valores.length === 0) {
                    loaderElement.innerText = "No hay datos para mostrar.";
                    if (grafico) grafico.destroy();
                    return;
                }
                
                loaderElement.style.display = 'none'; // Ocultar loader

                if (grafico) {
                    grafico.destroy();
                }

                grafico = new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: labels, // Estos labels se usarán por defecto si no se personaliza la leyenda
                        datasets: [{
                            data: valores,
                            backgroundColor: [
                                '#36A2EB', '#FFCE56', '#FF6384', '#4BC0C0', '#9966FF',
                                '#FF9F40', '#8AC926', '#1982C4', '#F45B69', '#6A4C93',
                                '#2ECC71', '#E74C3C', '#F1C40F', '#7F8C8D', '#D35400'
                            ],
                            borderColor: '#4A4A4A', // Un borde un poco más oscuro para el tema oscuro
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        layout: {
                            padding: { // Espacio alrededor del gráfico
                                top: 0, 
                                left: 0, 
                                right: 0, 
                                bottom: 0
                            }
                        },
                        plugins: {
                            title: {
                                display: true,
                                text: titulo || 'Distribución de Fondos',
                                color: '#FFFFFF', // Blanco para el título
                                font: {
                                    size: 18,
                                    weight: 'bold'
                                },
                                padding: {
                                    top: 10,
                                    bottom: 25 // Más espacio después del título
                                }
                            },
                            legend: {
                                display: true, // Mostrar leyenda
                                position: 'right', // Posición vertical (puedes probar 'left')
                                align: 'center', // Centrar ítems de leyenda en su espacio
                                labels: {
                                    color: '#FFFFFF', // Blanco para texto de leyenda por defecto
                                    boxWidth: 15,
                                    padding: 15,
                                    font: {
                                        size: 12
                                    },
                                    // Función para generar etiquetas personalizadas en la leyenda
                                    generateLabels: function(chart) {
                                        const data = chart.data;
                                        if (data.labels.length && data.datasets.length) {
                                            return data.labels.map((label, i) => {
                                                const meta = chart.getDatasetMeta(0);
                                                const style = meta.controller.getStyle(i);
                                                const valor = data.datasets[0].data[i];
                                                const porcentaje = totalGeneral > 0 ? (parseFloat(valor) / totalGeneral * 100).toFixed(2) : 0;
                                                
                                                // Ajusta 'USD' a la moneda que uses si es diferente
                                                const texto = `${label}: ${formatCurrency(valor, 'USD')} (${porcentaje}%)`;

                                                return {
                                                    text: texto,
                                                    fillStyle: style.backgroundColor,
                                                    strokeStyle: style.borderColor,
                                                    lineWidth: style.borderWidth,
                                                    hidden: !chart.getDataVisibility(i),
                                                    index: i,
                                                    // Propiedades adicionales para forzar color si es necesario
                                                    fontColor: '#FFFFFF' 
                                                };
                                            });
                                        }
                                        return [];
                                    }
                                }
                            },
                            tooltip: {
                                enabled: true,
                                backgroundColor: 'rgba(0,0,0,0.85)',
                                titleColor: '#FFFFFF',
                                bodyColor: '#FFFFFF',
                                titleFont: { size: 14, weight: 'bold' },
                                bodyFont: { size: 12 },
                                padding: 10,
                                callbacks: {
                                    label: function(context) {
                                        let label = context.label || ''; // Este es el label del dataset, no el de la torta
                                        const dataLabel = context.chart.data.labels[context.dataIndex];
                                        const value = context.parsed;

                                        if (dataLabel) {
                                            label = dataLabel + ': ';
                                        }
                                        if (value !== null) {
                                            // Ajusta 'USD' a la moneda que uses si es diferente
                                            label += formatCurrency(value, 'USD');
                                            const percentage = totalGeneral > 0 ? (value / totalGeneral * 100).toFixed(2) + '%' : '0.00%';
                                            label += ' (' + percentage + ')';
                                        }
                                        return label;
                                    }
                                }
                            }
                        }
                    }
                });
            } else {
                console.warn("Datos recibidos para el gráfico no tienen el formato esperado o faltan:", event.data);
                if (grafico) grafico.destroy(); // Destruir si ya existía un gráfico
                loaderElement.innerText = "Error: Datos inválidos.";
                loaderElement.style.display = 'block'; // Asegurarse de que el loader se muestre si hay error de datos
            }
        });

        // Mensaje inicial si no llegan datos después de un tiempo (opcional)
        // setTimeout(() => {
        //     if (!grafico && loaderElement.innerText === "Cargando gráfico...") {
        //         loaderElement.innerText = "No se recibieron datos.";
        //     }
        // }, 5000); // Espera 5 segundos
    </script>
</body>
</html>
