<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Distribución de Fondos</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: transparent !important;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100vw;
            height: 100vh;
            font-family: Arial, sans-serif;
            color: #ffffff; 
        }
        #chartContainer {
            display: flex; 
            width: 98%;
            height: 98%;
            max-width: 750px; /* Un poco más de espacio total */
        }
        #canvasWrapper {
            flex-grow: 1; 
            position: relative; 
            min-width: 0; 
        }
        canvas {
            display: block;
            width: 100%;
            height: 100%;
        }
        #loader {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 16px;
            color: #ffffff; 
        }
    </style>
</head>
<body>
    <div id="chartContainer">
        <div id="canvasWrapper">
            <canvas id="graficoTorta"></canvas>
            <div id="loader">Cargando gráfico...</div>
        </div>
        </div>

    <script>
        const ctx = document.getElementById('graficoTorta').getContext('2d');
        const loaderElement = document.getElementById('loader');
        let grafico;

        function formatCurrency(value, currency = 'USD') { // Asegúrate que la moneda por defecto sea la correcta para ti
            return new Intl.NumberFormat('es-VE', { style: 'currency', currency: currency, minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(value);
        }

        window.addEventListener('message', (event) => {
            // Opcional: Verificación de origen
            // const allowedOrigins = ['https://TU-DOMINIO-WIX.wixsite.com', 'https://editor.wix.com', 'https://cyrusfire.github.io'];
            // if (!allowedOrigins.includes(event.origin)) { /* ... manejo de error ... */ return; }

            if (event.data &&
                typeof event.data === 'object' &&
                Array.isArray(event.data.labels) &&
                Array.isArray(event.data.valores)) {

                const { labels, valores, titulo } = event.data;
                const totalGeneral = valores.reduce((sum, val) => sum + parseFloat(val), 0);

                if (labels.length === 0 || valores.length === 0 || totalGeneral === 0) { // Añadida comprobación de totalGeneral
                    loaderElement.innerText = "No hay datos suficientes para mostrar.";
                    if (grafico) grafico.destroy();
                    loaderElement.style.display = 'block';
                    return;
                }
                
                loaderElement.style.display = 'none';

                if (grafico) {
                    grafico.destroy();
                }

                grafico = new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: valores,
                            backgroundColor: [
                                '#36A2EB', '#FFCE56', '#FF6384', '#4BC0C0', '#9966FF',
                                '#FF9F40', '#8AC926', '#1982C4', '#F45B69', '#6A4C93',
                                '#2ECC71', '#E74C3C', '#F1C40F', '#7F8C8D', '#D35400'
                            ],
                            borderColor: '#4A4A4A',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        layout: {
                            padding: { top: 5, left: 5, right: 5, bottom: 5 }
                        },
                        plugins: {
                            title: {
                                display: true,
                                text: titulo || 'Distribución de Fondos',
                                color: '#FFFFFF',
                                font: {
                                    size: 18, // Tamaño del título un poco más grande
                                    weight: 'bold'
                                },
                                padding: {
                                    top: 10,
                                    bottom: 20 
                                }
                            },
                            legend: {
                                display: true,
                                position: 'right', // Leyenda a la derecha (actúa como tu lista)
                                align: 'start', // Alinea los ítems de la leyenda al inicio (arriba) de su contenedor
                                labels: {
                                    color: '#FFFFFF',
                                    boxWidth: 15, // Ancho del cuadrito de color
                                    padding: 20,  // Espacio entre ítems de la leyenda
                                    font: {
                                        size: 13 // Tamaño de fuente de la leyenda aumentado
                                    },
                                    generateLabels: function(chart) {
                                        const data = chart.data;
                                        if (data.labels.length && data.datasets.length) {
                                            return data.labels.map((label, i) => {
                                                const meta = chart.getDatasetMeta(0);
                                                const style = meta.controller.getStyle(i);
                                                const valor = data.datasets[0].data[i];
                                                // Evitar división por cero si totalGeneral es 0
                                                const porcentaje = totalGeneral > 0 ? (parseFloat(valor) / totalGeneral * 100).toFixed(2) : "0.00";
                                                
                                                // AQUÍ SE CONSTRUYE EL TEXTO DE CADA ÍTEM DE LA LEYENDA/LISTA
                                                const texto = `${label}: ${formatCurrency(valor)} (${porcentaje}%)`;

                                                return {
                                                    text: texto,
                                                    fillStyle: style.backgroundColor,
                                                    strokeStyle: style.borderColor,
                                                    lineWidth: style.borderWidth,
                                                    hidden: !chart.getDataVisibility(i),
                                                    index: i,
                                                    fontColor: '#FFFFFF' // Forzar color de fuente
                                                };
                                            });
                                        }
                                        return [];
                                    }
                                }
                            },
                            tooltip: { // El tooltip seguirá funcionando como antes
                                enabled: true,
                                backgroundColor: 'rgba(0,0,0,0.85)',
                                titleColor: '#FFFFFF',
                                bodyColor: '#FFFFFF',
                                titleFont: { size: 14, weight: 'bold' },
                                bodyFont: { size: 12 },
                                padding: 10,
                                callbacks: {
                                    label: function(context) {
                                        let label = '';
                                        const dataLabel = context.chart.data.labels[context.dataIndex];
                                        const value = context.parsed;

                                        if (dataLabel) {
                                            label = dataLabel + ': ';
                                        }
                                        if (value !== null) {
                                            label += formatCurrency(value);
                                            const percentage = totalGeneral > 0 ? (value / totalGeneral * 100).toFixed(2) + '%' : '0.00%';
                                            label += ' (' + percentage + ')';
                                        }
                                        return label;
                                    }
                                }
                            }
                        }
                    }
                });
            } else {
                console.warn("Datos recibidos para el gráfico no tienen el formato esperado o faltan:", event.data);
                if (grafico) grafico.destroy();
                loaderElement.innerText = "Error: Datos inválidos.";
                loaderElement.style.display = 'block';
            }
        });
    </script>
</body>
</html>
